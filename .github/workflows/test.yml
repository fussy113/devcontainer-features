name: Test Devcontainer Features

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - id: set-matrix
        run: |
          echo "Finding directories under src/..."
          dirs=()
          for d in src/*/ ; do
            if [ -d "$d" ]; then
              dirs+=("$(basename "$d")")
            fi
          done

          # Build JSON array like: [{"name":"sample"}, {"name":"other"}]
          json="["
          first=true
          for d in "${dirs[@]}"; do
            if [ "$first" = true ]; then first=false; else json+=", "; fi
            json+="{\"name\":\"$d\"}"
          done
          json+="]"

          echo "matrix=$json" >> "$GITHUB_OUTPUT"
        shell: bash

  test-autogenerated:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
        baseImage:
          - debian:latest
          - ubuntu:latest
          - mcr.microsoft.com/devcontainers/base:ubuntu
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 'lts/*'
      - name: Install devcontainer-cli
        run: npm install -g @devcontainers/cli
      - name: exec autogenerated feature tests
        run: devcontainer features test --skip-scenarios -f ${{ matrix.features.name }} -i ${{ matrix.baseImage }} .

  test:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node.js
        uses: actions/setup-node@3235b876344d2a9aa001b8d1453c930bba69e610 # v3.9.1
        with:
          node-version: 'lts/*'
      - name: Install devcontainer-cli
        run: npm install -g @devcontainers/cli
      - name: exec feature tests
        run: devcontainer features test --features ${{ matrix.features.name }} --skip-autogenerated --skip-duplicated .

  test-global:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 'lts/*'
      - name: Install devcontainer-cli
        run: npm install -g @devcontainers/cli
      - name: exec global tests
        run: devcontainer features test --global-scenarios-only .
